!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";o.r(t);class n extends Worker{constructor(){super(void 0)}}var r=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function c(e){try{d(n.next(e))}catch(e){i(e)}}function s(e){try{d(n.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(c,s)}d((n=n.apply(e,t||[])).next())}))};const i=navigator.usb;const c=[{vendorId:9025,productId:32822},{vendorId:9025,productId:32823},{vendorId:9025,productId:32845},{vendorId:9025,productId:32846},{vendorId:9025,productId:32847},{vendorId:9025,productId:32848},{vendorId:9025,productId:32850},{vendorId:9025,productId:32851},{vendorId:9025,productId:32852},{vendorId:9025,productId:32853},{vendorId:9025,productId:32854},{vendorId:9025,productId:32855},{vendorId:9025,productId:66},{vendorId:9114}],s=c;function d(e,t){var o,n,r,i,c,s;return e.vendorId==(null!=(o=t.vendorId)?o:e.vendorId)&&e.productId==(null!=(n=t.productId)?n:e.productId)&&e.deviceClass==(null!=(r=t.classCode)?r:e.deviceClass)&&e.deviceSubclass==(null!=(i=t.subclassCode)?i:e.deviceSubclass)&&e.deviceProtocol==(null!=(c=t.protocolCode)?c:e.deviceProtocol)&&e.serialNumber==(null!=(s=t.serialNumber)?s:e.serialNumber)}function l(e){return r(this,void 0,void 0,(function*(){const t=yield function(e){return r(this,void 0,void 0,(function*(){let t=yield i.getDevices();const o=[];for(const n of e||[])t.forEach(e=>{d(e,n)&&o.push(e)});return o}))}([e]);if(t.length>1)throw new Error("Found more than one matching port for filter");return new u(t[0])}))}let a=(e,...t)=>{};a=console.log;class u{constructor(e,t,o){this.device=e,this.onReceive=t,this.onReceiveError=o,this.init=!1,this.encoder=new TextEncoder,this.decoder=new TextDecoder}get filter(){return{vendorId:(e=this.device).vendorId,productId:e.productId,classCode:e.deviceClass,subclassCode:e.deviceSubclass,protocolCode:e.deviceProtocol,serialNumber:e.serialNumber};var e}connect(){return r(this,void 0,void 0,(function*(){const e=()=>{this.device.transferIn(this.ifaze.in,64).then(t=>{"ok"===t.status?this.onReceive&&this.onReceive(t.data):console.log(t),e()},e=>{this.onReceiveError&&this.onReceiveError(e)})};yield this.device.open(),null===this.device.configuration&&(yield this.device.selectConfiguration(1));if(this.device.configuration.interfaces.forEach(e=>{const t=e.alternates.find(e=>255===e.interfaceClass);t&&(this.ifaze={clazz:t.interfaceClass,num:e.interfaceNumber,out:t.endpoints.find(e=>"out"===e.direction).endpointNumber,in:t.endpoints.find(e=>"in"===e.direction).endpointNumber})}),!this.ifaze)throw new Error("Unable to find USB interface");try{yield this.device.claimInterface(this.ifaze.num),yield this.device.selectAlternateInterface(this.ifaze.num,0),yield this.device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:1,index:this.ifaze.num}),this.init=!0,a("USB interface claimed",this.ifaze)}catch(e){console.log("Error claiming USB interface",e)}e()}))}disconnect(){return r(this,void 0,void 0,(function*(){this.init&&(yield this.device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:0,index:this.ifaze.num}),yield this.device.close())}))}send(e){return this.init?this.device.transferOut(this.ifaze.out,this.encoder.encode(e)):(a("ERROR: USB interface not claimed/initialized"),Promise.resolve(null))}}class f{constructor(e){this.port=e}startPoll(e){this.port&&(this.pollInterval=setInterval(()=>{this.port.send(e.command)},e.interval))}stopPoll(){console.log("stopPoll"),this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)}raw(e){this.port.send(e.endsWith("\r\n")?e:e+"\r\n")}openPort(){this.port.connect()}closePort(){console.log("closePort"),this.stopPoll(),this.port&&(this.port.onReceive=null,this.port.disconnect().then(()=>{},e=>{console.log("error on disconnect",e)}),this.port=null)}}var v=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function c(e){try{d(n.next(e))}catch(e){i(e)}}function s(e){try{d(n.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(c,s)}d((n=n.apply(e,t||[])).next())}))};const p=self;let h;function I(e){p.postMessage(e)}let y="";function m(e){try{const t=JSON.parse(e);if(t.ADC){const e=t;for(const t of e.ADC){if(t.error)return void I({action:"error",payload:e});t.values=t.values.map((e,t)=>{const o=255&e;return 5*(((65280&e)>>8)-o)/255>.4?-e:5*o/255})}I({action:"adc",payload:e})}else t.setup?I({action:"log",payload:t}):t.type?I({action:"type",payload:t}):I({action:"log",payload:t})}catch(t){I({action:"error",payload:{command:e,error:t}})}}function b(e){return v(this,void 0,void 0,(function*(){y="",h&&g();const t=yield l(e);t.onReceive=e=>{const t=(new TextDecoder).decode(e),o=t.split("");if(o.length>1)do{const e=o.shift(),t=y+e;y="",t.length>0&&m(t)}while(o.length>0);else y+=t},t.onReceiveError=e=>{console.log(e),g()},(h=new f(t)).openPort(),I({action:"port-opened",filter:t.filter})}))}function g(){h&&(h.closePort(),h=null),I({action:"port-closed"})}p.onmessage=function(e){var t,o,n;return v(this,void 0,void 0,(function*(){const r=e.data;switch(r.action){case"enumerate":p.postMessage((yield i.getDevices().then(e=>(console.log("found devices",e),e.map(e=>`Product ${e.productName} manufacturer ${e.manufacturerName}`)))).join("\n"));break;case"open-port":b(r.filter);break;case"close-port":g();break;case"start-poll":null===(t=h)||void 0===t||t.startPoll(r);break;case"stop-poll":null===(o=h)||void 0===o||o.stopPoll();break;case"raw":null===(n=h)||void 0===n||n.raw(r.value)}}))},I({action:"worker-ready"}),navigator.usb.addEventListener("disconnect",e=>{g()}),navigator.usb.addEventListener("connect",e=>{for(const t of s)d(e.device,t)&&b(t)});t.default=n}]);
//# sourceMappingURL=test.worker.993801054e288acb06db.js.map